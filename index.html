<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapAnnotator - Interactive Map Labeling Tool</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link href="css/custom-styles.css" rel="stylesheet">
</head>
<body>
    <!-- Header Toolbar -->
    <header class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-geo-alt-fill"></i>
                MapAnnotator
            </span>
            
            <div class="navbar-nav d-flex flex-row gap-2">
                <!-- File Operations -->
                <div class="nav-item dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-folder"></i> File
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <label class="dropdown-item" for="map-file-input">
                                <i class="bi bi-image"></i> Load Map
                            </label>
                            <input type="file" id="map-file-input" accept="image/*" style="display: none;">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item" id="save-json-btn"><i class="bi bi-download"></i> Save Project</button></li>
                        <li>
                            <label class="dropdown-item" for="load-json-input">
                                <i class="bi bi-upload"></i> Load Project
                            </label>
                            <input type="file" id="load-json-input" accept=".json" style="display: none;">
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item" id="export-png-btn"><i class="bi bi-image"></i> Export PNG</button></li>
                    </ul>
                </div>
                
                <!-- Map Controls -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light btn-sm" id="zoom-in-btn" title="Zoom In">
                        <i class="bi bi-zoom-in"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="zoom-out-btn" title="Zoom Out">
                        <i class="bi bi-zoom-out"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="zoom-reset-btn" title="Reset Zoom">
                        <i class="bi bi-aspect-ratio"></i>
                    </button>
                </div>

                <!-- History Controls -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light btn-sm" id="undo-btn" title="Undo (Ctrl+Z)" disabled>
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="redo-btn" title="Redo (Ctrl+Y)" disabled>
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>

                <!-- Tools -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-light btn-sm" id="search-btn" title="Search Labels (Ctrl+F)">
                        <i class="bi bi-search"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="grid-btn" title="Toggle Grid (G)">
                        <i class="bi bi-grid-3x3"></i>
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="snap-btn" title="Toggle Snap to Grid (S)">
                        <i class="bi bi-magnet"></i>
                    </button>
                </div>
                
                <!-- Label Operations -->
                <div class="nav-item dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-tags"></i> Labels
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" id="clear-labels-btn"><i class="bi bi-trash"></i> Remove All Labels</button></li>
                        <li><button class="dropdown-item" id="clear-map-btn"><i class="bi bi-x-circle"></i> Clear Map</button></li>
                    </ul>
                </div>
                
                <!-- Theme Toggle -->
                <button class="btn btn-outline-light btn-sm" id="theme-toggle-btn" title="Toggle Dark Mode">
                    <i class="bi bi-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container-fluid p-0">
        <div class="map-container" id="map-container">
            <!-- Map Canvas Area -->
            <div class="map-viewport" id="map-viewport">
                <div class="map-transform-container" id="map-transform-container">
                    <canvas id="map-canvas" class="map-canvas" role="img" aria-label="Map image with annotations"></canvas>
                    <div class="labels-layer" id="labels-layer" role="region" aria-label="Map labels"></div>
                </div>
            </div>
            
            <!-- Search Interface -->
            <div class="search-panel" id="search-panel" style="display: none;">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-search text-muted"></i>
                            <input type="text" class="form-control form-control-sm flex-grow-1" id="search-input" placeholder="Search labels...">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="search-prev-btn" title="Previous Result" disabled>
                                <i class="bi bi-chevron-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="search-next-btn" title="Next Result" disabled>
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="search-close-btn" title="Close Search">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <div class="search-results mt-2" id="search-results" style="display: none;">
                            <small class="text-muted">
                                <span id="search-count">0 results</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="empty-state">
                <div class="text-center">
                    <i class="bi bi-image display-1 text-muted"></i>
                    <h3 class="text-muted mt-3">No Map Loaded</h3>
                    <p class="text-muted">Load a JPG or PNG image to start annotating</p>
                    <label class="btn btn-primary" for="map-file-input-main">
                        <i class="bi bi-upload"></i> Load Map Image
                    </label>
                    <input type="file" id="map-file-input-main" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
    </main>

    <!-- Status Bar -->
    <footer class="bg-light border-top py-2">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="small text-muted">
                <span id="status-text">Ready</span>
            </div>
            <div class="small text-muted">
                <span id="autosave-status">Autosave ready</span>
            </div>
            <div class="small text-muted">
                Zoom: <span id="zoom-level">100%</span> | 
                Labels: <span id="label-count">0</span>
            </div>
        </div>
    </footer>

    <!-- Label Editor Modal (Desktop) -->
    <div class="modal fade" id="label-editor-modal" tabindex="-1" aria-labelledby="label-editor-title" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="label-editor-title">Add Label</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <!-- Label Text -->
                            <div class="mb-3">
                                <label for="label-text-input" class="form-label">Label Text</label>
                                <input type="text" class="form-control" id="label-text-input" placeholder="Enter label text">
                            </div>
                            
                            <!-- Font Size and Color Row -->
                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <label for="font-size-input" class="form-label">Font Size</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="font-size-input" value="16" min="8" max="96">
                                        <span class="input-group-text">px</span>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label for="label-color-input" class="form-label">Text Color</label>
                                    <input type="color" class="form-control form-control-color" id="label-color-input" value="#222222">
                                </div>
                            </div>
                            
                            <!-- Label Background -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="background-enabled-checkbox">
                                    <label class="form-check-label" for="background-enabled-checkbox">
                                        Add background
                                    </label>
                                </div>
                                <div class="row background-controls" id="background-controls" style="display: none;">
                                    <div class="col-sm-6">
                                        <label for="background-color-input" class="form-label">Background Color</label>
                                        <input type="color" class="form-control form-control-color" id="background-color-input" value="#ffffff">
                                    </div>
                                    <div class="col-sm-6">
                                        <label for="background-opacity-input" class="form-label">Opacity</label>
                                        <div class="input-group">
                                            <input type="range" class="form-range" id="background-opacity-input" min="0" max="100" value="80">
                                            <span class="input-group-text"><span id="opacity-value">80</span>%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Icon Selector -->
                            <div class="mb-3">
                                <label class="form-label">Icon</label>
                                <div class="icon-selector" id="icon-selector">
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-geo-alt-fill" value="geo-alt-fill" checked>
                                    <label class="btn btn-outline-primary" for="icon-geo-alt-fill"><i class="bi bi-geo-alt-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-star-fill" value="star-fill">
                                    <label class="btn btn-outline-primary" for="icon-star-fill"><i class="bi bi-star-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-heart-fill" value="heart-fill">
                                    <label class="btn btn-outline-primary" for="icon-heart-fill"><i class="bi bi-heart-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-flag-fill" value="flag-fill">
                                    <label class="btn btn-outline-primary" for="icon-flag-fill"><i class="bi bi-flag-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-house-fill" value="house-fill">
                                    <label class="btn btn-outline-primary" for="icon-house-fill"><i class="bi bi-house-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-tree-fill" value="tree-fill">
                                    <label class="btn btn-outline-primary" for="icon-tree-fill"><i class="bi bi-tree-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-diamond-fill" value="diamond-fill">
                                    <label class="btn btn-outline-primary" for="icon-diamond-fill"><i class="bi bi-diamond-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-circle-fill" value="circle-fill">
                                    <label class="btn btn-outline-primary" for="icon-circle-fill"><i class="bi bi-circle-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-square-fill" value="square-fill">
                                    <label class="btn btn-outline-primary" for="icon-square-fill"><i class="bi bi-square-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-triangle-fill" value="triangle-fill">
                                    <label class="btn btn-outline-primary" for="icon-triangle-fill"><i class="bi bi-triangle-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-exclamation-triangle-fill" value="exclamation-triangle-fill">
                                    <label class="btn btn-outline-primary" for="icon-exclamation-triangle-fill"><i class="bi bi-exclamation-triangle-fill"></i></label>
                                    
                                    <input type="radio" class="btn-check" name="icon-choice" id="icon-info-circle-fill" value="info-circle-fill">
                                    <label class="btn btn-outline-primary" for="icon-info-circle-fill"><i class="bi bi-info-circle-fill"></i></label>
                                </div>
                            </div>
                            
                            <!-- Tooltip Notes -->
                            <div class="mb-3">
                                <label for="tooltip-textarea" class="form-label">
                                    Tooltip Notes 
                                    <span class="text-muted small">(<span id="char-counter">0</span>/500)</span>
                                </label>
                                <textarea class="form-control" id="tooltip-textarea" rows="3" maxlength="500" placeholder="Optional notes that appear on hover/tap"></textarea>
                            </div>
                            
                            <!-- Background Settings -->
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="background-enabled" value="">
                                    <label class="form-check-label" for="background-enabled">
                                        Enable background color
                                    </label>
                                </div>
                                <div id="background-controls" class="mt-2" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <label for="background-color-input" class="form-label">Background Color</label>
                                            <input type="color" class="form-control form-control-color" id="background-color-input" value="#ffffff">
                                        </div>
                                        <div class="col-6">
                                            <label for="background-opacity-input" class="form-label">Opacity</label>
                                            <div class="input-group">
                                                <input type="range" class="form-range" id="background-opacity-input" min="0.1" max="1" step="0.1" value="0.8">
                                                <span class="input-group-text" id="opacity-value">80%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Preview -->
                        <div class="col-md-4">
                            <div class="label-preview" id="label-preview">
                                <div class="preview-title mb-2">
                                    <small class="text-muted">Preview</small>
                                </div>
                                <div class="preview-label" id="preview-label">
                                    <i class="bi bi-geo-alt-fill" id="preview-icon"></i>
                                    <span id="preview-text">Sample Label</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="delete-label-btn" style="display: none;">Delete</button>
                    <button type="button" class="btn btn-primary" id="create-label-btn">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Label Editor Offcanvas (Mobile) -->
    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="label-editor-offcanvas" aria-labelledby="label-editor-offcanvas-title">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="label-editor-offcanvas-title">Add Label</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <!-- Same content as modal but single column -->
            <div class="mb-3">
                <label for="mobile-label-text-input" class="form-label">Label Text</label>
                <input type="text" class="form-control" id="mobile-label-text-input" placeholder="Enter label text">
            </div>
            
            <div class="row mb-3">
                <div class="col-6">
                    <label for="mobile-font-size-input" class="form-label">Font Size</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="mobile-font-size-input" value="16" min="8" max="96">
                        <span class="input-group-text">px</span>
                    </div>
                </div>
                <div class="col-6">
                    <label for="mobile-label-color-input" class="form-label">Color</label>
                    <input type="color" class="form-control form-control-color" id="mobile-label-color-input" value="#222222">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Icon</label>
                <div class="mobile-icon-selector" id="mobile-icon-selector">
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-geo-alt-fill" value="geo-alt-fill" checked>
                    <label class="btn btn-outline-primary" for="mobile-icon-geo-alt-fill"><i class="bi bi-geo-alt-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-star-fill" value="star-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-star-fill"><i class="bi bi-star-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-heart-fill" value="heart-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-heart-fill"><i class="bi bi-heart-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-flag-fill" value="flag-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-flag-fill"><i class="bi bi-flag-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-house-fill" value="house-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-house-fill"><i class="bi bi-house-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-tree-fill" value="tree-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-tree-fill"><i class="bi bi-tree-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-diamond-fill" value="diamond-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-diamond-fill"><i class="bi bi-diamond-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-circle-fill" value="circle-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-circle-fill"><i class="bi bi-circle-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-square-fill" value="square-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-square-fill"><i class="bi bi-square-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-triangle-fill" value="triangle-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-triangle-fill"><i class="bi bi-triangle-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-exclamation-triangle-fill" value="exclamation-triangle-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-exclamation-triangle-fill"><i class="bi bi-exclamation-triangle-fill"></i></label>
                    
                    <input type="radio" class="btn-check" name="mobile-icon-choice" id="mobile-icon-info-circle-fill" value="info-circle-fill">
                    <label class="btn btn-outline-primary" for="mobile-icon-info-circle-fill"><i class="bi bi-info-circle-fill"></i></label>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="mobile-tooltip-textarea" class="form-label">
                    Tooltip Notes 
                    <span class="text-muted small">(<span id="mobile-char-counter">0</span>/500)</span>
                </label>
                <textarea class="form-control" id="mobile-tooltip-textarea" rows="3" maxlength="500" placeholder="Optional notes that appear on hover/tap"></textarea>
            </div>
            
            <!-- Mobile Background Settings -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="mobile-background-enabled" value="">
                    <label class="form-check-label" for="mobile-background-enabled">
                        Enable background color
                    </label>
                </div>
                <div id="mobile-background-controls" class="mt-2" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <label for="mobile-background-color-input" class="form-label">Background Color</label>
                            <input type="color" class="form-control form-control-color" id="mobile-background-color-input" value="#ffffff">
                        </div>
                        <div class="col-6">
                            <label for="mobile-background-opacity-input" class="form-label">Opacity</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="mobile-background-opacity-input" min="0.1" max="1" step="0.1" value="0.8">
                                <span class="input-group-text" id="mobile-opacity-value">80%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Preview -->
            <div class="mb-3">
                <div class="preview-title mb-2">
                    <small class="text-muted">Preview</small>
                </div>
                <div class="preview-label" id="mobile-preview-label">
                    <i class="bi bi-geo-alt-fill" id="mobile-preview-icon"></i>
                    <span id="mobile-preview-text">Sample Label</span>
                </div>
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                <button type="button" class="btn btn-danger" id="mobile-delete-label-btn" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" id="mobile-create-label-btn">Create</button>
            </div>
        </div>
    </div>

    <!-- Export Dialog -->
    <div class="modal fade" id="export-modal" tabindex="-1" aria-labelledby="export-modal-title" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="export-modal-title">Export PNG</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Export Size</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-size" id="export-native" value="native" checked>
                            <label class="form-check-label" for="export-native">
                                Native Resolution (1×)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-size" id="export-scale" value="scale">
                            <label class="form-check-label" for="export-scale">
                                Scale Factor
                            </label>
                            <div class="mt-2 ms-4">
                                <input type="range" class="form-range" id="scale-range" min="0.5" max="4" step="0.25" value="2" disabled>
                                <div class="d-flex justify-content-between">
                                    <span class="small text-muted">0.5×</span>
                                    <span class="small text-muted" id="scale-value">2.0×</span>
                                    <span class="small text-muted">4.0×</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export-size" id="export-width" value="width">
                            <label class="form-check-label" for="export-width">
                                Target Width (pixels)
                            </label>
                            <div class="mt-2 ms-4">
                                <div class="input-group" style="width: 200px;">
                                    <input type="number" class="form-control" id="target-width-input" value="1920" min="100" max="8192" disabled>
                                    <span class="input-group-text">px</span>
                                </div>
                                <small class="text-muted">Height will be calculated automatically</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="export-confirm-btn">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip Container -->
    <div id="tooltip-container" class="tooltip-container" role="tooltip"></div>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- App Scripts -->
    <script type="module" src="js/mapannotator.js"></script>
</body>
</html>
